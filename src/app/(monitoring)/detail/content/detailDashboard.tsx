"use client";

import React, { useState, useEffect, useMemo } from "react";
import { Chart, useChartStore } from "@/app/store/useChartStore";
import { PanelLayout, useDashboardStore } from "@/app/store/useDashboardStore";
import { useRouter, useSearchParams } from "next/navigation";
import { Layout, Responsive, WidthProvider } from "react-grid-layout";
import AddChartBar from "@/app/components/bar/addChartBar";
import TimeRangeBar from "@/app/components/bar/timeRangeBar";
import ChartWidget from "@/app/components/dashboard/chartWidget";
import CommonWidget from "@/app/components/dashboard/commonWidget";
import CustomTable from "@/app/components/table/customTable";
import TabMenu from "@/app/components/menu/tabMenu";
import { MoreVertical } from "lucide-react";
import { useWidgetStore, Widget } from "@/app/store/useWidgetStore";
import { v4 as uuidv4 } from "uuid";
import Alert from "@/app/components/alert/alert";
import { convertToTable } from "@/app/utils/convertToTable";
import {
  MIN_CHART_WIDTH,
  MIN_CHART_HEIGHT,
  MIN_WIDGET_WIDTH,
  MIN_WIDGET_HEIGHT,
  MAX_WIDGET_WIDTH,
  MAX_WIDGET_HEIGHT,
  MAX_CHART_HEIGHT,
  MAX_CHART_WIDTH,
} from "@/app/data/chart/chartDetail";

const ResponsiveGridLayout = WidthProvider(Responsive);

const DetailDashboard = () => {
  const router = useRouter();
  const id = useSearchParams();
  const dashboardId = id.get("id") || "1";

  const { charts, addChart, removeChart } = useChartStore();
  const { widgets, addWidget, removeWidget } = useWidgetStore();
  const { dashboardPanels, addPanelToDashboard, dashboardList, saveDashboard } =
    useDashboardStore();

  const [from, setFrom] = useState<string | null>(null);
  const [to, setTo] = useState<string | null>(null);
  const [refreshTime, setRefreshTime] = useState<number | "autoType">(10);
  const [lastUpdated, setLastUpdated] = useState<string | null>(null);
  const [menuOpenIndex, setMenuOpenIndex] = useState<string | null>(null);
  const [isCloneModalOpen, setIsCloneModalOpen] = useState<boolean>(false);
  const [selectedDashboard, setSelectedDashboard] = useState<string | null>(
    null
  );
  const [selectedItem, setSelectedItem] = useState<string | null>(null);
  const [alertMessage, setAlertMessage] = useState<string>("");
  const [gridLayout, setGridLayout] = useState<
    { i: string; x: number; y: number; w: number; h: number }[]
  >([]);
  const [isEditing, setIsEditing] = useState<boolean>(false);
  const [prevLayout, setPrevLayout] = useState<Layout[]>([]);

  const layouts = useMemo(() => ({ lg: gridLayout }), [gridLayout]);

  const handleEditClick = () => {
    if (isEditing) {
      // "Save" Î≤ÑÌäºÏùÑ ÎàåÎ†ÄÏùÑ Îïå ÏúÑÏπò Î∞è ÌÅ¨Í∏∞ Ï†ÄÏû•
      const updatedLayouts: PanelLayout[] = gridLayout.map((layout) => ({
        panelId: layout.i,
        type:
          dashboardPanels[dashboardId]?.find(
            (panel) => panel.panelId === layout.i
          )?.type || "chart",
        x: layout.x,
        y: layout.y,
        w: layout.w,
        h: layout.h,
      }));

      saveDashboard(dashboardId, updatedLayouts);
    }
    setIsEditing((prev) => !prev);
  };

  const chartDataList = (dashboardPanels[dashboardId] || [])
    .filter((panel) => panel.type === "chart")
    .map((panel) =>
      charts[dashboardId]?.find((chart) => chart?.chartId === panel.panelId)
    )
    .filter((chart): chart is Chart => !!chart);

  const widgetDataList = (dashboardPanels[dashboardId] || [])
    .filter((panel) => panel.type === "widget")
    .map((panel) =>
      widgets[dashboardId]?.find((widget) => widget?.widgetId === panel.panelId)
    )
    .filter((widget): widget is Widget => !!widget);

  const handleTabClone = (itemId: string) => {
    setSelectedItem(itemId);
    setIsCloneModalOpen(true);
  };

  const confirmClone = () => {
    if (!selectedDashboard || !selectedItem) return;

    const targetDashboardId = selectedDashboard;
    let newItemId: string | null = null;

    // Ï∞®Ìä∏ Î≥µÏ†ú
    const existingChart = Object.values(charts)
      .flat()
      .find((chart) => chart.chartId === selectedItem);

    if (existingChart) {
      const newChartId = uuidv4();
      const clonedChartOptions = { ...existingChart.chartOptions };
      const clonedDatasets = existingChart.datasets.map((dataset) => ({
        ...dataset,
      }));

      addChart(targetDashboardId, clonedChartOptions, clonedDatasets);
      addPanelToDashboard(targetDashboardId, newChartId, "chart");

      newItemId = newChartId;
    }

    // ÏúÑÏ†Ø Î≥µÏ†ú
    const existingWidget = Object.values(widgets)
      .flat()
      .find((widget) => widget.widgetId === selectedItem);

    if (existingWidget) {
      const newWidgetId = uuidv4();
      const clonedWidgetOptions = {
        ...existingWidget.widgetOptions,
        widgetId: newWidgetId, // ÏÉàÎ°úÏö¥ ID Ï†ÅÏö©
      };

      addWidget(targetDashboardId, clonedWidgetOptions);
      addPanelToDashboard(targetDashboardId, newWidgetId, "widget");
      newItemId = newWidgetId;
    }

    if (newItemId) {
      setAlertMessage("ÏÑ†ÌÉùÌïú Ï∞®Ìä∏/ÏúÑÏ†ØÏù¥ Î≥µÏ†úÎêòÏóàÏäµÎãàÎã§!");
    } else {
      setAlertMessage("Î≥µÏ†úÌï† Ìï≠Î™©Ïù¥ ÏóÜÏäµÎãàÎã§.");
    }

    setIsCloneModalOpen(false);
  };

  const closeCloneModal = () => {
    setIsCloneModalOpen(false);
    setSelectedDashboard(null);
  };

  const handleLayoutChange = (layout: Layout[]) => {
    // ÏÉÅÌÉúÍ∞Ä Î≥ÄÍ≤ΩÎêòÏßÄ ÏïäÏïòÎã§Î©¥ ÏóÖÎç∞Ïù¥Ìä∏ÌïòÏßÄ ÏïäÏùå
    if (JSON.stringify(prevLayout) === JSON.stringify(layout)) {
      return;
    }

    // Î†àÏù¥ÏïÑÏõÉÏù¥ Î≥ÄÍ≤ΩÎêú Í≤ΩÏö∞ÏóêÎßå Ï≤òÎ¶¨
    const updatedLayouts: PanelLayout[] = layout.map((l) => ({
      panelId: l.i, // `i`Î•º `panelId`Î°ú Îß§Ìïë
      type:
        dashboardPanels[dashboardId]?.find((p) => p.panelId === l.i)?.type ||
        "chart",
      x: l.x,
      y: l.y,
      w: l.w,
      h: l.h,
    }));

    // Î†àÏù¥ÏïÑÏõÉ Î≥ÄÍ≤ΩÏù¥ Ïã§Ï†úÎ°ú ÏûàÏùÑ ÎïåÎßå ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
    setGridLayout(layout);
    setPrevLayout(layout); // Ïù¥Ï†Ñ Î†àÏù¥ÏïÑÏõÉ Í∞±Ïã†
    saveDashboard(dashboardId, updatedLayouts); // ZustandÏóê Î†àÏù¥ÏïÑÏõÉ Ï†ÄÏû•
  };

  useEffect(() => {
    // Ï¥àÍ∏∞Ìôî Ïãú Zustand ÏÉÅÌÉúÏóêÏÑú Í∞ÄÏ†∏ÏôÄ Ï†ÅÏö©
    if (
      dashboardPanels[dashboardId] &&
      dashboardPanels[dashboardId].length > 0 &&
      gridLayout.length === 0
    ) {
      const savedLayout = dashboardPanels[dashboardId].map((panel) => ({
        i: panel.panelId,
        x: panel.x,
        y: panel.y,
        w: panel.w,
        h: panel.h,
      }));

      console.log("üìå ZustandÏóêÏÑú Î∂àÎü¨Ïò® gridLayout ÏÑ§Ï†ï: ", savedLayout);
      setGridLayout(savedLayout);
      setPrevLayout(savedLayout); // Ï¥àÍ∏∞Í∞í ÏÑ§Ï†ï
    }
  }, [dashboardPanels, dashboardId]);

  return (
    <div className="bg-ivory-bg_sub min-h-[calc(100vh-80px)]">
      <AddChartBar
        isEdit={isEditing}
        onCreateClick={() => router.push(`/d?id=${dashboardId}`)}
        gridCols={2}
        onGridChange={() => {}}
        gridVisible={true}
        modifiable={true}
        onEditClick={handleEditClick}
      />

      <TimeRangeBar
        from={from}
        to={to}
        lastUpdated={lastUpdated}
        refreshTime={refreshTime}
        onChange={(type, value) =>
          type === "from" ? setFrom(value) : setTo(value)
        }
        onRefreshChange={setRefreshTime}
      />
      <div className="relative w-full">
        <ResponsiveGridLayout
          className="layout"
          layouts={layouts}
          rowHeight={70}
          isDraggable={isEditing}
          isResizable={isEditing}
          compactType={null}
          preventCollision={true}
          onLayoutChange={handleLayoutChange}
          maxRows={20} // ÏµúÎåÄ Ï§Ñ Ïàò Ï†úÌïú
          draggableHandle=".drag-handle"
          resizeHandles={["se"]}
        >
          {chartDataList.map((chart) => {
            const chartLayout = gridLayout.find(
              (item) => item.i === chart.chartId
            ) || {
              i: chart.chartId,
              x: 0,
              y: 0,
              w: 4,
              h: Math.max(MIN_WIDGET_HEIGHT, 4),
              minW: MIN_CHART_WIDTH,
              minH: MIN_CHART_HEIGHT,
            };

            return (
              <div
                key={chart.chartId}
                data-grid={{
                  ...chartLayout,
                  minW: MIN_CHART_WIDTH,
                  minH: MIN_CHART_HEIGHT,
                }}
                className={`drag-handle cursor-grab`}
              >
                <div className="border rounded-lg bg-white p-4 shadow-md h-full flex flex-col relative">
                  {/* Î©îÎâ¥ Î≤ÑÌäº (Í∏∞Ï°¥ Ïú†ÏßÄ) */}
                  <div className="absolute top-2 right-2 z-10 pointer-events-auto">
                    <MoreVertical
                      className="text-text3 cursor-pointer hover:text-text2"
                      onClick={(e) => {
                        e.stopPropagation();
                        setMenuOpenIndex(
                          menuOpenIndex === chart.chartId ? null : chart.chartId
                        );
                      }}
                    />
                    {menuOpenIndex === chart.chartId && (
                      <TabMenu
                        index={chart.chartId}
                        setEditingTabIndex={() =>
                          router.push(
                            `/d?id=${dashboardId}&chartId=${chart.chartId}`
                          )
                        }
                        setIsModalOpen={() => {}}
                        setMenuOpenIndex={setMenuOpenIndex}
                        handleTabDelete={() =>
                          removeChart(dashboardId, chart.chartId)
                        }
                        handleTabClone={handleTabClone}
                      />
                    )}
                  </div>

                  {/* Ï†úÎ™© */}
                  <h2 className="text-lg font-semibold mb-2">
                    {chart.chartOptions.titleText}
                  </h2>

                  {/* Ï∞®Ìä∏ ÎòêÎäî ÌÖåÏù¥Î∏î Î†åÎçîÎßÅ */}
                  <div className="flex-1 overflow-hidden">
                    {chart.chartOptions.displayMode === "chart" ? (
                      <ChartWidget
                        type={chart.chartOptions.chartType}
                        datasets={chart.datasets || []}
                        options={chart.chartOptions}
                      />
                    ) : (
                      <CustomTable
                        columns={[
                          { key: "name", label: "ID" },
                          ...chart.datasets.map((dataset) => ({
                            key: dataset.label,
                            label: dataset.label,
                          })),
                        ]}
                        data={convertToTable(chart.datasets).rows}
                        title={chart.chartOptions.titleText}
                      />
                    )}
                  </div>
                </div>
              </div>
            );
          })}

          {widgetDataList.map((widget) => {
            const widgetLayout = gridLayout.find(
              (item) => item.i === widget.widgetId
            ) || {
              i: widget.widgetId,
              x: 0,
              y: 0,
              w: 4, // Í∏∞Î≥∏ Í∞ÄÎ°ú ÌÅ¨Í∏∞
              h: Math.max(MIN_WIDGET_HEIGHT, 4), // Í∏∞Î≥∏ ÏÑ∏Î°ú ÌÅ¨Í∏∞
              minW: MIN_WIDGET_WIDTH, // ÏµúÏÜå Í∞ÄÎ°ú ÌÅ¨Í∏∞ ÏÑ§Ï†ï
              minH: MIN_WIDGET_HEIGHT, // ÏµúÏÜå ÏÑ∏Î°ú ÌÅ¨Í∏∞ ÏÑ§Ï†ï
            };

            return (
              <div
                key={widget.widgetId}
                data-grid={{
                  ...widgetLayout, // widgetLayoutÏóêÏÑú x, y, w, h Í∞íÏùÑ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
                  minW: 2,
                  maxW: 4,
                  minH: MIN_WIDGET_HEIGHT, // ÏµúÏÜå ÏÑ∏Î°ú ÌÅ¨Í∏∞ ÏÑ§Ï†ï
                }}
                className="drag-handle cursor-grab"
              >
                {/* max-h-[230px] max-w-[530px] */}
                <div className="relative flex flex-col h-full min-w-72 min-h-32">
                  <div className="absolute top-2 right-2 z-10 pointer-events-auto">
                    <MoreVertical
                      className="text-text3 cursor-pointer hover:text-text2"
                      onClick={(e) => {
                        e.stopPropagation();
                        setMenuOpenIndex(
                          menuOpenIndex === widget.widgetId
                            ? null
                            : widget.widgetId
                        );
                      }}
                    />
                    {menuOpenIndex === widget.widgetId && (
                      <TabMenu
                        index={widget.widgetId}
                        setEditingTabIndex={() =>
                          router.push(
                            `/d?id=${dashboardId}&chartId=${widget.widgetId}`
                          )
                        }
                        setIsModalOpen={() => {}}
                        setMenuOpenIndex={setMenuOpenIndex}
                        handleTabDelete={() =>
                          removeWidget(dashboardId, widget.widgetId)
                        }
                        handleTabClone={handleTabClone}
                      />
                    )}
                  </div>
                  {/* ÏúÑÏ†Ø Î†åÎçîÎßÅ */}
                  <CommonWidget
                    backgroundColor={widget.widgetOptions.widgetBackgroundColor}
                    {...widget.widgetOptions}
                    className="scale-[1] w-full h-full"
                  />
                </div>
              </div>
            );
          })}
        </ResponsiveGridLayout>
      </div>
      {isCloneModalOpen && (
        <div className="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-[100]">
          <div className="bg-white p-6 rounded-lg shadow-lg w-96">
            <h2 className="text-lg font-bold mb-4">ÎåÄÏãúÎ≥¥Îìú ÏÑ†ÌÉù</h2>
            <ul>
              {dashboardList.map((dashboard) => (
                <li
                  key={dashboard.id}
                  onClick={() => setSelectedDashboard(dashboard.id)}
                  className={`cursor-pointer p-2 rounded ${
                    selectedDashboard === dashboard.id
                      ? "bg-navy-btn text-white"
                      : "hover:bg-gray-100"
                  }`}
                >
                  {dashboard.label}
                </li>
              ))}
            </ul>
            <div className="flex justify-end mt-4">
              <button
                onClick={closeCloneModal}
                className="mr-2 px-4 py-2 bg-gray-200 rounded text-md2"
              >
                Ï∑®ÏÜå
              </button>
              <button
                onClick={confirmClone}
                disabled={!selectedDashboard}
                className={`px-4 py-2 rounded text-md2 text-white ${
                  selectedDashboard ? "bg-navy-btn" : "bg-navy-btn opacity-80"
                }`}
              >
                ÌôïÏù∏
              </button>
            </div>
          </div>
        </div>
      )}
      {alertMessage && <Alert message={alertMessage} />}
    </div>
  );
};

export default DetailDashboard;
